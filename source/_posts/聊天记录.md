---
title: 解密QQ聊天记录
type: categories
categories: 教程
copyright: true
tags:
  - QQ
date: '2017/07/01 15:57:33'
abbrlink: 1060d444
---

### 前言

从2013年开始，手机QQ就已经不支持聊天记录的导出功能了，目的是为了推广超级会员（超级会员的聊天记录有2年漫游时间），我一直都想实现导出聊天记录的功能，最近总算是实现了。

### 思路

我是在网上找了许久，没有完全解决“导出聊天记录”这个问题帖子，我也试了许久，算是比较完美了。

QQ的数据库文件保存在`data/data/com.tencent.monileqq/databases/{QQ号}.db`，里面不仅有聊天记录，还有所有好友和群的信息。

不幸的是，里面的数据被加密了。

另外很幸运的是，就是加密方式采用的伟大的“异或加密”，那么是原本的聊天记录和谁加密呢？这个网上基本都有提到，就是你手机的[IMEI](https://zh.wikipedia.org/wiki/IMEI)，所有手机的IMEI都是不同的，这货就相当于手机的身份证，既然知道了加密方式，那么解密自然也就不是难事了。

先想一下，我们聊天记录想导出成什么格式发：

我的想法是：`时间--发信人--内容`这样的格式，最重要的当然是内容啦。

如下图，mr_friend_\**...**\_New就是你每一个好友的信息，包括昵称、网名、qq号码、聊天记录等，直接查看就会发现是被加密过的。

![](https://ws1.sinaimg.cn/large/ba22af52gy1fh3iut526vj20qt0igju1.jpg)



由于QQ的数据库是sqlite，而python有很方便的sqlite的工具，这里就采用python来解密。

用浏览工具打开数据库，以我的数据库为例：

![](https://ws1.sinaimg.cn/large/ba22af52gy1fh3j5olc02j21120elgnv.jpg)

`msgData`保存的就是聊天记录，`selfuin`就是聊天对象的QQ号码，`time`就是发送消息的时间，既然知道了这三个就是我们想要的，那么接下来的就好办多了，解密这三个就好了。

### 解密

```python
IMEI = '**'#这里输入你的IMEI码
conn = sqlite3.connect(db_name)
cursor = conn.execute("SELECT *  from mr_friend_**_New ")
for row in cursor:
    sbstr = ''
    msgData = row[13]
    for i in range(len(msgData)):
        try:
            tmp = bytes([msgData[i] ^ ord(IMEI[i % 15])])
            sbstr += tmp
        except:
            pass
```

上述代码的sbstr就是每一句消息的内容，由于本程序代码具有攻击性，避免有人用作不法用途，就只将核心代码公布，不把全部的代码公布。